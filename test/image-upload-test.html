<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡ä¸Šå‚³æ¸¬è©¦</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #34C759;
        }
        .error {
            border-left: 4px solid #FF3B30;
        }
        .warning {
            border-left: 4px solid #FF9500;
        }
        input[type="file"] {
            background: #3a3a3a;
            color: #fff;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>RentRipple åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½æ¸¬è©¦</h1>

    <div class="test-section">
        <h2>ğŸ¯ Production Environment Test</h2>
        <p>æ¸¬è©¦ç’°å¢ƒï¼š<span id="api-url">https://bangkokmrt.vercel.app</span></p>
        <div>
            <input type="file" id="test-file" accept="image/*" />
            <button class="test-button" onclick="testNormalUpload()">æ¸¬è©¦æ­£å¸¸ä¸Šå‚³</button>
            <button class="test-button" onclick="testLargeFileUpload()">æ¸¬è©¦å¤§æª”æ¡ˆ (>5MB)</button>
            <button class="test-button" onclick="testUnsupportedFormat()">æ¸¬è©¦ä¸æ”¯æ´æ ¼å¼</button>
            <button class="test-button" onclick="testEmptyFile()">æ¸¬è©¦ç©ºæª”æ¡ˆ</button>
            <button class="test-button" onclick="testLongFilename()">æ¸¬è©¦è¶…é•·æª”å</button>
        </div>
        <div id="upload-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æ‰¹é‡æ¸¬è©¦</h2>
        <button class="test-button" onclick="runAllTests()" id="batch-test-btn">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
        <button class="test-button" onclick="testConcurrentUploads()">æ¸¬è©¦ä½µç™¼ä¸Šå‚³</button>
        <div id="batch-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ” ç¶²è·¯æ¸¬è©¦</h2>
        <button class="test-button" onclick="testNetworkFailure()">æ¨¡æ“¬ç¶²è·¯å¤±æ•—</button>
        <button class="test-button" onclick="testCORSHeaders()">æ¸¬è©¦ CORS</button>
        <button class="test-button" onclick="testAPIEndpoint()">æ¸¬è©¦ API ç«¯é»</button>
        <div id="network-result" class="result" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'https://bangkokmrt.vercel.app';

        function log(message, type = 'info', containerId = 'upload-result') {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.className = `result ${type}`;
            container.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
        }

        function clearLog(containerId = 'upload-result') {
            const container = document.getElementById(containerId);
            container.textContent = '';
            container.style.display = 'none';
        }

        // å‰µå»ºæ¸¬è©¦åœ–ç‰‡
        function createTestImage(width = 100, height = 100, format = 'png') {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // å‰µå»ºæ¼¸å±¤èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#FF6B6B');
            gradient.addColorStop(1, '#4ECDC4');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // æ·»åŠ æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('TEST', width/2, height/2);

            return canvas.toDataURL(`image/${format}`);
        }

        // æ¸¬è©¦æ­£å¸¸ä¸Šå‚³
        async function testNormalUpload() {
            clearLog();
            const fileInput = document.getElementById('test-file');

            try {
                let imageData, imageName;

                if (fileInput.files.length > 0) {
                    // ä½¿ç”¨ç”¨æˆ¶é¸æ“‡çš„æª”æ¡ˆ
                    const file = fileInput.files[0];
                    imageName = file.name;

                    const reader = new FileReader();
                    imageData = await new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });

                    log(`ä½¿ç”¨ç”¨æˆ¶æª”æ¡ˆ: ${imageName} (${(file.size / 1024).toFixed(2)} KB)`);
                } else {
                    // å‰µå»ºæ¸¬è©¦åœ–ç‰‡
                    imageData = createTestImage(300, 200, 'png');
                    imageName = 'test-normal-upload.png';
                    log('ä½¿ç”¨è‡ªå‹•ç”Ÿæˆçš„æ¸¬è©¦åœ–ç‰‡');
                }

                log('é–‹å§‹ä¸Šå‚³...');
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData, imageName })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`âœ… ä¸Šå‚³æˆåŠŸ!`, 'success');
                    log(`URL: ${result.url}`, 'success');
                    log(`æª”æ¡ˆå: ${result.fileName}`, 'success');

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯ä»¥è¨ªå•
                    const img = new Image();
                    img.onload = () => log('âœ… åœ–ç‰‡å¯æ­£å¸¸è¨ªå•', 'success');
                    img.onerror = () => log('âŒ åœ–ç‰‡ç„¡æ³•è¨ªå•', 'error');
                    img.src = result.url;
                } else {
                    log(`âŒ ä¸Šå‚³å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦å¤§æª”æ¡ˆä¸Šå‚³
        async function testLargeFileUpload() {
            clearLog();
            log('å‰µå»ºå¤§æª”æ¡ˆ (>5MB)...');

            // å‰µå»ºå¤§åœ–ç‰‡ (6MB+)
            const imageData = createTestImage(3000, 2000, 'png');
            const imageName = 'test-large-file.png';

            const sizeInMB = (imageData.length * 0.75) / (1024 * 1024); // base64 ç´„ç‚ºåŸå§‹å¤§å°çš„ 4/3
            log(`æª”æ¡ˆå¤§å°: ${sizeInMB.toFixed(2)} MB`);

            try {
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData, imageName })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`âŒ é æœŸæ‡‰è©²å¤±æ•—ä½†å»æˆåŠŸäº†`, 'warning');
                } else {
                    log(`âœ… æ­£ç¢ºæ‹’çµ•å¤§æª”æ¡ˆ: ${result.error}`, 'success');
                }
            } catch (error) {
                log(`âœ… æ­£ç¢ºè™•ç†éŒ¯èª¤: ${error.message}`, 'success');
            }
        }

        // æ¸¬è©¦ä¸æ”¯æ´æ ¼å¼
        async function testUnsupportedFormat() {
            clearLog();
            log('æ¸¬è©¦ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼...');

            // å‰µå»ºå‡çš„ PDF æ ¼å¼
            const imageData = 'data:application/pdf;base64,JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PAovVHlwZSAvQ2F0YWxvZwo+PgplbmRvYmoKMiAwIG9iago8PAovVHlwZSAvUGFnZXMKPj4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCnhyZWYKMCA0CjAwMDAwMDAwMDAgNjU1MzUgZiAKdHJhaWxlcgo8PAovU2l6ZSA0Cj4+CnN0YXJ0eHJlZgo5CiUlRU9G';
            const imageName = 'test-unsupported.pdf';

            try {
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData, imageName })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`âŒ é æœŸæ‡‰è©²å¤±æ•—ä½†å»æˆåŠŸäº†`, 'warning');
                } else {
                    log(`âœ… æ­£ç¢ºæ‹’çµ•ä¸æ”¯æ´æ ¼å¼: ${result.error}`, 'success');
                }
            } catch (error) {
                log(`âœ… æ­£ç¢ºè™•ç†éŒ¯èª¤: ${error.message}`, 'success');
            }
        }

        // æ¸¬è©¦ç©ºæª”æ¡ˆ
        async function testEmptyFile() {
            clearLog();
            log('æ¸¬è©¦ç©ºæª”æ¡ˆ...');

            const imageData = 'data:image/png;base64,';
            const imageName = 'test-empty.png';

            try {
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData, imageName })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`âŒ é æœŸæ‡‰è©²å¤±æ•—ä½†å»æˆåŠŸäº†`, 'warning');
                } else {
                    log(`âœ… æ­£ç¢ºæ‹’çµ•ç©ºæª”æ¡ˆ: ${result.error}`, 'success');
                }
            } catch (error) {
                log(`âœ… æ­£ç¢ºè™•ç†éŒ¯èª¤: ${error.message}`, 'success');
            }
        }

        // æ¸¬è©¦è¶…é•·æª”å
        async function testLongFilename() {
            clearLog();
            log('æ¸¬è©¦è¶…é•·æª”å...');

            const imageData = createTestImage(100, 100, 'png');
            const imageName = 'a'.repeat(150) + '.png'; // 150 å­—å…ƒæª”å

            try {
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData, imageName })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`âŒ é æœŸæ‡‰è©²å¤±æ•—ä½†å»æˆåŠŸäº†`, 'warning');
                } else {
                    log(`âœ… æ­£ç¢ºæ‹’çµ•è¶…é•·æª”å: ${result.error}`, 'success');
                }
            } catch (error) {
                log(`âœ… æ­£ç¢ºè™•ç†éŒ¯èª¤: ${error.message}`, 'success');
            }
        }

        // æ¸¬è©¦ä½µç™¼ä¸Šå‚³
        async function testConcurrentUploads() {
            clearLog('batch-result');
            log('æ¸¬è©¦ä½µç™¼ä¸Šå‚³ (5 å€‹åŒæ™‚ä¸Šå‚³)...', 'info', 'batch-result');

            const promises = [];
            for (let i = 0; i < 5; i++) {
                const imageData = createTestImage(200, 150, 'png');
                const imageName = `concurrent-test-${i + 1}.png`;

                const promise = fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData, imageName })
                });
                promises.push(promise);
            }

            try {
                const results = await Promise.allSettled(promises);
                let successCount = 0;
                let errorCount = 0;

                for (let i = 0; i < results.length; i++) {
                    if (results[i].status === 'fulfilled') {
                        const response = results[i].value;
                        if (response.ok) {
                            successCount++;
                            log(`âœ… ä½µç™¼ä¸Šå‚³ ${i + 1} æˆåŠŸ`, 'success', 'batch-result');
                        } else {
                            errorCount++;
                            const error = await response.json();
                            log(`âŒ ä½µç™¼ä¸Šå‚³ ${i + 1} å¤±æ•—: ${error.error}`, 'error', 'batch-result');
                        }
                    } else {
                        errorCount++;
                        log(`âŒ ä½µç™¼ä¸Šå‚³ ${i + 1} éŒ¯èª¤: ${results[i].reason}`, 'error', 'batch-result');
                    }
                }

                log(`\nä½µç™¼æ¸¬è©¦çµæœ: ${successCount} æˆåŠŸ, ${errorCount} å¤±æ•—`, 'info', 'batch-result');
            } catch (error) {
                log(`âŒ ä½µç™¼æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error', 'batch-result');
            }
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        async function runAllTests() {
            const button = document.getElementById('batch-test-btn');
            button.disabled = true;
            button.textContent = 'åŸ·è¡Œä¸­...';

            clearLog('batch-result');
            log('é–‹å§‹åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...', 'info', 'batch-result');

            const tests = [
                { name: 'æ­£å¸¸ä¸Šå‚³', func: testNormalUpload },
                { name: 'å¤§æª”æ¡ˆä¸Šå‚³', func: testLargeFileUpload },
                { name: 'ä¸æ”¯æ´æ ¼å¼', func: testUnsupportedFormat },
                { name: 'ç©ºæª”æ¡ˆ', func: testEmptyFile },
                { name: 'è¶…é•·æª”å', func: testLongFilename }
            ];

            for (const test of tests) {
                log(`\n--- ${test.name} ---`, 'info', 'batch-result');
                try {
                    await test.func();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // é–“éš” 1 ç§’
                } catch (error) {
                    log(`âŒ ${test.name} æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error', 'batch-result');
                }
            }

            log('\nâœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ!', 'success', 'batch-result');
            button.disabled = false;
            button.textContent = 'åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦';
        }

        // æ¸¬è©¦ API ç«¯é»
        async function testAPIEndpoint() {
            clearLog('network-result');
            log('æ¸¬è©¦ API ç«¯é»å¯ç”¨æ€§...', 'info', 'network-result');

            try {
                // æ¸¬è©¦ OPTIONS è«‹æ±‚
                const optionsResponse = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'OPTIONS'
                });

                if (optionsResponse.ok) {
                    log('âœ… OPTIONS è«‹æ±‚æˆåŠŸ', 'success', 'network-result');
                    log(`CORS æ¨™é ­: ${optionsResponse.headers.get('Access-Control-Allow-Origin')}`, 'info', 'network-result');
                } else {
                    log('âŒ OPTIONS è«‹æ±‚å¤±æ•—', 'error', 'network-result');
                }

                // æ¸¬è©¦éŒ¯èª¤çš„è«‹æ±‚æ–¹æ³•
                const getResponse = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'GET'
                });

                if (getResponse.status === 405) {
                    log('âœ… æ­£ç¢ºæ‹’çµ• GET è«‹æ±‚', 'success', 'network-result');
                } else {
                    log('âŒ GET è«‹æ±‚æ‡‰è©²è¢«æ‹’çµ•', 'error', 'network-result');
                }

            } catch (error) {
                log(`âŒ ç¶²è·¯æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error', 'network-result');
            }
        }

        // æ¸¬è©¦ CORS
        async function testCORSHeaders() {
            clearLog('network-result');
            log('æ¸¬è©¦ CORS æ¨™é ­...', 'info', 'network-result');

            try {
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin
                    }
                });

                log(`ç‹€æ…‹ç¢¼: ${response.status}`, 'info', 'network-result');
                log(`Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}`, 'info', 'network-result');
                log(`Access-Control-Allow-Methods: ${response.headers.get('Access-Control-Allow-Methods')}`, 'info', 'network-result');
                log(`Access-Control-Allow-Headers: ${response.headers.get('Access-Control-Allow-Headers')}`, 'info', 'network-result');

            } catch (error) {
                log(`âŒ CORS æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error', 'network-result');
            }
        }

        // æ¨¡æ“¬ç¶²è·¯å¤±æ•—
        async function testNetworkFailure() {
            clearLog('network-result');
            log('æ¨¡æ“¬ç¶²è·¯å¤±æ•—...', 'info', 'network-result');

            const controller = new AbortController();
            setTimeout(() => controller.abort(), 100); // 100ms å¾Œå–æ¶ˆè«‹æ±‚

            try {
                const imageData = createTestImage(100, 100, 'png');
                const response = await fetch(`${API_BASE}/api/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData,
                        imageName: 'network-test.png'
                    }),
                    signal: controller.signal
                });

                log('âŒ è«‹æ±‚æ‡‰è©²è¢«å–æ¶ˆ', 'error', 'network-result');
            } catch (error) {
                if (error.name === 'AbortError') {
                    log('âœ… æ­£ç¢ºè™•ç†ç¶²è·¯ä¸­æ–·', 'success', 'network-result');
                } else {
                    log(`âœ… æ­£ç¢ºè™•ç†ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'success', 'network-result');
                }
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºAPI URL
        document.getElementById('api-url').textContent = API_BASE;
    </script>
</body>
</html>